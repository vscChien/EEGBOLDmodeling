% Campagnola, Luke, et al. "Local connectivity and synaptic dynamics 
%  in mouse and human neocortex." Science 375.6585 (2022): eabj5861.
%
% P [17x17] to x from: connection probabilities 
% P2 [16x16] to x from: connection probabilities (L5ET and L5IT merged)

function [P,P2]=compagnola_conn(plotOn)
    if nargin<1
        plotOn=1;
    end

    % 'L23Pyr', 'L23PV','L23SST','L23VIP','L4Pyr', 'L4PV','L4SST','L4VIP','L5PyrET','L5PyrTT', 'L5PV','L5SST','L5VIP','L6Pyr', 'L6PV','L6SST','L6VIP',
    % [to x from]
    P =[0.11,0.79,0.76,0.38, 0.12, 0.61, 0.4, 0,       0.5, 0,         0, 0.1, 0, 0, 0, 0, 0;
        0.65, 0.79, 0.28, 0, 0.4, 0.42, 0, 0,           0.17, 0.41,     0.56, 0, 0.57, 0, 0, 0, 0;
        0.42, 0.44, 0.17, 0.92, 0.06, 0.66, 0, 0.43,    0, 0,        0.25, 0, 0, 0, 0, 0, 0; 
        0.11, 0.04, 0.49, 0.05, 0, 0, 0.44, 0.25,       0, 0,        0.11, 0, 0.27, 0, 0, 0, 0;
        0.17, 0.53, 0.09, 0.05, 0.22, 0.36, 0.1, 0,     0, 0,        0.69, 0.08, 0.3, 0, 0, 0, 0;
        0.7, 0.53, 0.16, 0.27, 0.52, 0.97, 0.14, 0.28,  0.25, 0.33,     0.41, 0, 0, 0, 1, 0, 0;
        0.61,0,0.18,0.56,0.54,0.67,0.04,0.82,           0,0.32,         0,0.12,0.26,0,0,0,0;
        0,0,1,0, 0, 0.04, 0.5, 0.13,                    0, 0,           0.18, 0.39, 0.23, 0, 0, 0, 0;

        0, 0, 0, 0, 0, 0, 0, 0,                         0.16, 0,        0.18, 0.23, 0, 0, 0, 0, 0;
        0, 0.14, 0, 0, 0, 0.1, 0.24, 0.07,              0.09, 0.06,     0.22, 0.26, 0.09, 0, 0.27, 0.1, 0;

        0.5, 0.45, 0, 0, 0.9, 0.66, 0, 0.19,            0.43, 0.38,     0.5, 0.14, 0.1, 0, 0.27, 0.11, 0;
        0.29, 0, 0.19, 0.34, 0.35, 0.63, 0.11, 0.66,    0.52, 0.13,     0.29, 0.1, 0.33, 0, 0.12, 0.07, 0;
        0,0,0,0,0,0,0.48,0,                             0,0,            0.02, 0.19,0.15,0.19,0,0.26,0.13;
        0,0,0,0,0,0,0,0,                                0,0,            0,0,0,0.01,0.43,0.31,0;
        0,0.46,0,0,0,1,0,0,                             0,0.36,         0.16,0.06,0.25,0.6,0.75,0.06,0.06;
        0,0,0,0.8,0,0,0,0,                              0,0.1,          0.22,0.04,0,0.15,0.34,0.16,0.71;
        0,0,0,0,0,0,0,0,                                0,0,            0,0,0,0,0.14,0.19,0]';

    % 'L23Pyr', 'L23PV','L23SST','L23VIP','L4Pyr', 'L4PV','L4SST','L4VIP','L5Pyr', 'L5PV','L5SST','L5VIP','L6Pyr', 'L6PV','L6SST','L6VIP',
    % [to x from]
     P2 =[0.11,0.79,0.76,0.38, 0.12, 0.61, 0.4, 0,      (0.5*12)/(12+15),         0, 0.1, 0, 0, 0, 0, 0;
        0.65, 0.79, 0.28, 0, 0.4, 0.42, 0, 0,           (0.17*11+0.41*21)/(11+21),     0.56, 0, 0.57, 0, 0, 0, 0;
        0.42, 0.44, 0.17, 0.92, 0.06, 0.66, 0, 0.43,    0,        0.25, 0, 0, 0, 0, 0, 0; 
        0.11, 0.04, 0.49, 0.05, 0, 0, 0.44, 0.25,       0,        0.11, 0, 0.27, 0, 0, 0, 0;
        0.17, 0.53, 0.09, 0.05, 0.22, 0.36, 0.1, 0,     0,        0.69, 0.08, 0.3, 0, 0, 0, 0;
        0.7, 0.53, 0.16, 0.27, 0.52, 0.97, 0.14, 0.28,  (0.25*16+0.33*31)/(16+31),     0.41, 0, 0, 0, 1, 0, 0;
        0.61,0,0.18,0.56,0.54,0.67,0.04,0.82,           (0.32*12)/(10+12),         0,0.12,0.26,0,0,0,0;
        0,0,1,0, 0, 0.04, 0.5, 0.13,                    0,           0.18, 0.39, 0.23, 0, 0, 0, 0;

        0, 0.14*24/(10+24), 0, 0, 0, 0.1*32/(19+32), 0.24*13/(10+13), (0.07*54)/(28+54),                         (0.16*739+0.09*88+0.06*1137)/(739+82+88+1137),        (0.18*57+0.22*116)/(57+116), (0.23*70+0.26*238)/(70+238), 0.09*59/(37+59),  0, 0.27, 0.1*24/(5+24), 0;
   
        0.5, 0.45, 0, 0, 0.9, 0.66, 0, 0.19,            (0.43*57+0.38*106)/(57+106),     0.5, 0.14, 0.1, 0, 0.27, 0.11, 0;
        0.29, 0, 0.19, 0.34, 0.35, 0.63, 0.11, 0.66,    (0.52*64+0.13*206)/(64+206),     0.29, 0.1, 0.33, 0, 0.12, 0.07, 0;
        0,0,0,0,0,0,0.48,0,                             0,            0.02, 0.19,0.15,0.19,0,0.26,0.13;
        0,0,0,0,0,0,0,0,                                0,            0,0,0,0.01,0.43,0.31,0;
        0,0.46,0,0,0,1,0,0,                             0.36,         0.16,0.06,0.25,0.6,0.75,0.06,0.06;
        0,0,0,0.8,0,0,0,0,                              (0.1*23)/(5+23),          0.22,0.04,0,0.15,0.34,0.16,0.71;
        0,0,0,0,0,0,0,0,                                0,            0,0,0,0,0.14,0.19,0]';




     if plotOn
        plot_table(P)
        plot_table2(P2)
     end

     %================a comparison with Billeh 2020===============
     %
     % Connection probabilities (to x from)
     % E2/3, PV2/3, SST2/3, VIP2/3, E4, PV4, SST4, VIP4, E5, PV5, SST5, VIP5, E6, PV6, SST6, VIP6
    connP0=[0.16,	0.395,	0.182,	0.105,	0.016,	0.083,	0.083,	0.083,	0.083,	0.081,	0.102,	0,	0,	0,	0,	0;...
    0.411,	0.451,	0.03,	0.22,	0.05,	0.05,	0.05,	0.05,	0.07,	0.073,	0,	0,	0,	0,	0,	0;...
    0.424,	0.857,	0.082,	0.77,	0.05,	0.05,	0.05,	0.05,	0.021,	0,	0,	0,	0,	0,	0,	0;...
    0.087,	0.02,	0.625,	0.028,	0.05,	0.05,	0.05,	0.05,	0,	0,	0,	0,	0,	0,	0,	0;...
    0.14,	0.1,	0.1,	0.1,	0.243,	0.43,	0.571,	0.571,	0.104,	0.101,	0.128,	0.05,	0.032,	0,	0,	0;...
    0.25,	0.05,	0.05,	0.05,	0.437,	0.451,	0.03,	0.22,	0.088,	0.091,	0.03,	0.03,	0,	0,	0,	0;...
    0.25,	0.05,	0.05,	0.05,	0.351,	0.857,	0.082,	0.77,	0.026,	0.03,	0,	0.03,	0,	0,	0,	0;...
    0.25,	0.05,	0.05,	0.05,	0.351,	0.02,	0.625,	0.028,	0,	0.03,	0.03,	0.03,	0,	0,	0,	0;...
    0.021,	0.05,	0.05,	0.05,	0.007,	0.05,	0.05,	0.05,	0.116,	0.083,	0.063,	0.105,	0.047,	0.03,	0.03,	0.03;...
    0,	0.102,	0,	0,	0,	0.034,	0.03,	0.03,	0.455,	0.361,	0.03,	0.22,	0.03,	0.01,	0.01,	0.01;...
    0.169,	0,	0.017,	0,	0.056,	0.03,	0.006,	0.03,	0.317,	0.857,	0.04,	0.77,	0.03,	0.01,	0.01,	0.01;...
    0,	0,	0,	0,	0.03,	0.03,	0.03,	0.03,	0.125,	0.02,	0.625,	0.02,	0.03,	0.01,	0.01,	0.01;...
    0,	0,	0,	0,	0,	0,	0,	0,	0.012,	0.01,	0.01,	0.01,	0.026,	0.145,	0.1,	0.1;...
    0.1,	0,	0,	0,	0.1,	0,	0,	0,	0.1,	0.03,	0.03,	0.03,	0.1,	0.08,	0.1,	0.08;...
    0,	0,	0,	0,	0,	0,	0,	0,	0.03,	0.03,	0.03,	0.03,	0.1,	0.05,	0.05,	0.05;...
    0,	0,	0,	0,	0,	0,	0,	0,	0.03,	0.03,	0.03,	0.03,	0.1,	0.05,	0.05,	0.03]'; % to x from

    if plotOn
       plot_table2(connP0)
       plot_table2((P2-connP0)./connP0)
    end
end

%==========================================================================
function plot_table(C)
  ttext={'L23Pyr', 'L23PV','L23SST','L23VIP','L4Pyr', 'L4PV','L4SST','L4VIP','L5PyrET','L5PyrTT', 'L5PV','L5SST','L5VIP','L6Pyr', 'L6PV','L6SST','L6VIP'};
  figure; hold on;
  for i=1:17
      for j=1:17
        text(j-0.5,17-(i-0.5),num2str(round(C(i,j),2)),'HorizontalAlignment','center')
      end
  end
  xlim([0 17]);ylim([0 17]);
  plot([1;1]*(1:16),ylim,'k')
  plot(xlim,[1;1]*(1:16),'k')
  box on;
  set(gca,'xtick',(1:17)-0.5,'xticklabel',ttext,'ytick',(1:17)-0.5,'yticklabel',fliplr(ttext),'xaxisLocation','top')
end
%==========================================================================
function plot_table2(C)
  ttext={'L23Pyr', 'L23PV','L23SST','L23VIP','L4Pyr', 'L4PV','L4SST','L4VIP','L5Pyr', 'L5PV','L5SST','L5VIP','L6Pyr', 'L6PV','L6SST','L6VIP'};
  figure; hold on;
  for i=1:16
      for j=1:16
        text(j-0.5,16-(i-0.5),num2str(round(C(i,j),2)),'HorizontalAlignment','center')
      end
  end
  xlim([0 16]);ylim([0 16]);
  plot([1;1]*(1:15),ylim,'k')
  plot(xlim,[1;1]*(1:15),'k')
  box on;
  set(gca,'xtick',(1:16)-0.5,'xticklabel',ttext,'ytick',(1:16)-0.5,'yticklabel',fliplr(ttext),'xaxisLocation','top')
end
